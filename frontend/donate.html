<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini æŠ•å–‚ç«™</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            color: white;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
        }

        .donate-button {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
            display: block;
            margin: 0 auto;
        }

        .donate-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(245, 87, 108, 0.6);
        }

        .donate-button:active {
            transform: translateY(0);
        }

        .accounts-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .accounts-card h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .account-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            transition: transform 0.2s;
        }

        .account-item:hover {
            transform: translateX(5px);
        }

        .account-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .account-label {
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
        }

        .account-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .account-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 1em;
            color: #333;
            font-weight: 500;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #f5c6cb;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #c3e6cb;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ Gemini æŠ•å–‚ç«™</h1>
            <p>åˆ†äº«ä½ çš„ Gemini è´¦å·ï¼Œè®©æ›´å¤šäººä½“éªŒ AI çš„é­…åŠ›</p>
        </div>

        <div class="stats-card">
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">æ€» Credits</div>
                    <div class="stat-value" id="totalCredits">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">æ´»è·ƒè´¦å·</div>
                    <div class="stat-value" id="activeAccounts">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">æ€»è´¦å·æ•°</div>
                    <div class="stat-value" id="totalAccounts">-</div>
                </div>
            </div>
            <button class="donate-button" onclick="startDonation()">
                âœ¨ æŠ•å–‚æˆ‘çš„ Gemini è´¦å·
            </button>
        </div>

        <div class="accounts-card">
            <h2>ğŸ“‹ è´¦å·åˆ—è¡¨</h2>
            <div id="accountsList">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨åŠ è½½è´¦å·ä¿¡æ¯...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å¯åŠ¨æŠ•å–‚æµç¨‹
        function startDonation() {
            // æ„å»º OAuth URL
            const clientId = '1071006060591-tmhssin2h21lcre235vtolojh4g403ep.apps.googleusercontent.com';
            const redirectUri = `${window.location.origin}/api/gemini/oauth-callback`;
            const scopes = [
                'https://www.googleapis.com/auth/cloud-platform',
                'https://www.googleapis.com/auth/userinfo.email',
                'https://www.googleapis.com/auth/userinfo.profile',
                'https://www.googleapis.com/auth/cclog',
                'https://www.googleapis.com/auth/experimentsandconfigs'
            ].join(' ');

            const state = generateState();
            const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
                `client_id=${encodeURIComponent(clientId)}` +
                `&redirect_uri=${encodeURIComponent(redirectUri)}` +
                `&response_type=code` +
                `&scope=${encodeURIComponent(scopes)}` +
                `&access_type=offline` +
                `&prompt=consent` +
                `&state=${state}`;

            // æ‰“å¼€æˆæƒé¡µé¢
            window.location.href = authUrl;
        }

        // ç”Ÿæˆéšæœº state
        function generateState() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
        }

        // åŠ è½½è´¦å·åˆ—è¡¨
        async function loadAccounts() {
            try {
                const response = await fetch('/api/gemini/accounts');
                if (!response.ok) {
                    throw new Error('åŠ è½½å¤±è´¥');
                }

                const data = await response.json();
                displayAccounts(data);
            } catch (error) {
                document.getElementById('accountsList').innerHTML = `
                    <div class="error">
                        âŒ åŠ è½½è´¦å·åˆ—è¡¨å¤±è´¥: ${error.message}
                    </div>
                `;
            }
        }

        // æ˜¾ç¤ºè´¦å·åˆ—è¡¨
        function displayAccounts(data) {
            const accountsList = document.getElementById('accountsList');

            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            document.getElementById('totalCredits').textContent = formatNumber(data.totalCredits || 0);
            document.getElementById('activeAccounts').textContent = data.activeCount || 0;
            document.getElementById('totalAccounts').textContent = data.totalCount || 0;

            // æ˜¾ç¤ºè´¦å·åˆ—è¡¨
            if (!data.accounts || data.accounts.length === 0) {
                accountsList.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                        </svg>
                        <h3>æš‚æ— è´¦å·</h3>
                        <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æŠ•å–‚ä½ çš„ç¬¬ä¸€ä¸ª Gemini è´¦å·å§ï¼</p>
                    </div>
                `;
                return;
            }

            accountsList.innerHTML = data.accounts.map(account => `
                <div class="account-item">
                    <div class="account-header">
                        <span class="account-label">${escapeHtml(account.label || 'æœªå‘½åè´¦å·')}</span>
                        <span class="account-status ${account.enabled ? 'status-active' : 'status-inactive'}">
                            ${account.enabled ? 'âœ“ æ´»è·ƒ' : 'âœ— ç¦ç”¨'}
                        </span>
                    </div>
                    <div class="account-details">
                        <div class="detail-item">
                            <span class="detail-label">å‰©ä½™ Credits</span>
                            <span class="detail-value">${formatNumber(account.credits || 0)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">é‡ç½®æ—¶é—´</span>
                            <span class="detail-value">${formatResetTime(account.resetTime)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">é¡¹ç›® ID</span>
                            <span class="detail-value">${escapeHtml(account.projectId || 'N/A')}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">æ·»åŠ æ—¶é—´</span>
                            <span class="detail-value">${formatDate(account.created_at)}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // æ ¼å¼åŒ–æ•°å­—
        function formatNumber(num) {
            return num.toLocaleString('zh-CN');
        }

        // æ ¼å¼åŒ–é‡ç½®æ—¶é—´
        function formatResetTime(resetTime) {
            if (!resetTime) return 'N/A';
            try {
                const date = new Date(resetTime);
                const now = new Date();
                const diff = date - now;

                if (diff < 0) return 'å·²é‡ç½®';

                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

                if (days > 0) {
                    return `${days}å¤©${hours}å°æ—¶`;
                } else {
                    return `${hours}å°æ—¶`;
                }
            } catch {
                return 'N/A';
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
            } catch {
                return 'N/A';
            }
        }

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰å›è°ƒå‚æ•°
        function checkCallback() {
            const params = new URLSearchParams(window.location.search);
            const success = params.get('success');
            const error = params.get('error');

            if (success === 'true') {
                const accountsList = document.getElementById('accountsList');
                accountsList.insertAdjacentHTML('afterbegin', `
                    <div class="success">
                        âœ“ è´¦å·æ·»åŠ æˆåŠŸï¼æ„Ÿè°¢ä½ çš„æŠ•å–‚ ğŸ‰
                    </div>
                `);
                // æ¸…é™¤ URL å‚æ•°
                window.history.replaceState({}, document.title, window.location.pathname);
            } else if (error) {
                const accountsList = document.getElementById('accountsList');
                accountsList.insertAdjacentHTML('afterbegin', `
                    <div class="error">
                        âŒ æ·»åŠ å¤±è´¥: ${escapeHtml(decodeURIComponent(error))}
                    </div>
                `);
                // æ¸…é™¤ URL å‚æ•°
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        window.addEventListener('DOMContentLoaded', () => {
            checkCallback();
            loadAccounts();
            // æ¯ 30 ç§’åˆ·æ–°ä¸€æ¬¡
            setInterval(loadAccounts, 30000);
        });
    </script>
</body>
</html>